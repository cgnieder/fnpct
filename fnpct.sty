% --------------------------------------------------------------------------
% the FNPCT package v 0.1
% 
%   messing with footnote kerning
% 
% 2012/05/18
% --------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://bitbucket.org/cgnieder/fnpct/
% E-Mail: contact@mychemistry.eu
% --------------------------------------------------------------------------
% Copyright 2012 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% --------------------------------------------------------------------------
% The fnpct package consists of the files
%  - fnpct.sty,
%  - README
% --------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% --------------------------------------------------------------------------
% the package is inspired by the following question on TeX.SE:
%   http://tex.stackexchange.com/q/56094/5049
% --------------------------------------------------------------------------
\RequirePackage { xparse , l3keys2e }
\ProvidesExplPackage
  {fnpct}
  {2012/05/18}
  {0.1}
  {mess with footnote kerning}

\dim_new:N \l_fnpct_after_comma_dim
\dim_set:Nn \l_fnpct_after_comma_dim { -.06em }
\dim_new:N \l_fnpct_after_dot_dim
\dim_set:Nn \l_fnpct_after_dot_dim { -.06em }
\dim_new:N \l_fnpct_before_comma_dim
\dim_set:Nn \l_fnpct_before_comma_dim { -.16em }
\dim_new:N \l_fnpct_before_dot_dim
\dim_set:Nn \l_fnpct_before_dot_dim { -.16em }
\dim_new:N \l_fnpct_before_footnote_dim
\dim_set:Nn \l_fnpct_before_footnote_dim { .06em }

\bool_new:N \l_fnpct_punct_after_bool

\keys_define:nn { fnpct }
  {
    after-comma-space     .dim_set:N  = \l_fnpct_after_comma_dim ,
    after-dot-space       .dim_set:N  = \l_fnpct_after_dot_dim ,
    before-comma-space    .dim_set:N  = \l_fnpct_before_comma_dim ,
    before-dot-space      .dim_set:N  = \l_fnpct_before_dot_dim ,
    after-punct-space     .code:n     =
      \dim_set:Nn \l_fnpct_after_comma_dim { #1 }
      \dim_set:Nn \l_fnpct_after_dot_dim { #1 } ,
    before-punct-space    .code:n     =
      \dim_set:Nn \l_fnpct_before_comma_dim { #1 }
      \dim_set:Nn \l_fnpct_before_dot_dim { #1 } ,
    before-footnote-space .dim_set:N  = \l_fnpct_before_footnote_dim ,
    punct-after           .bool_set:N = \l_fnpct_punct_after_bool ,
    punct-after           .default:n  = true
  }

\ProcessKeysOptions { fnpct }

\AtBeginDocument
  {
    % save definition of \footnote
    \cs_new_eq:NN \fnpct_orig_footnote:w \footnote
    \cs_new_eq:NN \fnpct_orig_footnotemark:w \footnotemark
    % redefine \footnote
    \RenewDocumentCommand \footnote { om }
      { \fnpct_dot_or_comma:Nnn \fnpct_orig_footnote:w { #1 } { #2 } }
    \RenewDocumentCommand \footnotemark { o }
      { \fnpct_dot_or_comma:Nnn \fnpct_orig_footnotemark:w { #1 } { } }
    \@ifpackageloaded { endnotes }
      {
        % save definition of \endnote
        \cs_new_eq:NN \fnpct_orig_endnote:w \endnote
        \cs_new_eq:NN \fnpct_orig_endnotemark:w \endnotemark
        % redefine \endnote
        \RenewDocumentCommand \endnote { om }
          { \fnpct_dot_or_comma:Nnn \fnpct_orig_endnote:w { #1 } { #2 } }
        \RenewDocumentCommand \endnotemark { o }
          { \fnpct_dot_or_comma:Nnn \fnpct_orig_endnotemark:w { #1 } { } }
      }
      { }
    \@ifpackageloaded { parnotes }
      {
        % save definition of \parnote
        \cs_new_eq:NN \fnpct_orig_parnote:w \parnote
%         \cs_new_eq:NN \fnpct_orig_parnotemark:w \parnotemark
        % redefine \parnote
        \RenewDocumentCommand \parnote { om }
          { \fnpct_dot_or_comma:Nnn \fnpct_orig_parnote:w { #1 } { #2 } }
%         \RenewDocumentCommand \parnotemark { o }
%           { \fnpct_dot_or_comma:Nnn \fnpct_orig_parnotemark:w { #1 } { } }
      }
      { }
  }

\bool_new:N \l_fnpct_multiple_footnotes_bool

% internal footnote function:
\cs_new:Npn \fnpct_dot_or_comma:Nnn #1#2#3
  {
    % if a dot follows remove it, insert dot, skip back
    % and then insert footnote
    \peek_meaning_remove:NTF .
      {
        \bool_if:NTF \l_fnpct_punct_after_bool
          { \skip_horizontal:N \l_fnpct_before_footnote_dim }
          { . \skip_horizontal:N \l_fnpct_after_dot_dim }
        \IfNoValueTF { #2 }
          { #1 { #3 } }
          { #1 [ #2 ] { #3 } }
        \bool_if:NT \l_fnpct_punct_after_bool
          { \skip_horizontal:N \l_fnpct_before_dot_dim . }
      }
      {
        % else do the same with comma
        \peek_meaning_remove:NTF ,
          {
            \bool_if:NTF \l_fnpct_punct_after_bool
              { \skip_horizontal:N \l_fnpct_before_footnote_dim }
              { , \skip_horizontal:N \l_fnpct_after_comma_dim }
            \IfNoValueTF { #2 }
              { #1 { #3 } }
              { #1 [ #2 ] { #3 } }
            \bool_if:NT \l_fnpct_punct_after_bool
              { \skip_horizontal:N \l_fnpct_before_comma_dim , }
          }
          {
            % what about multiple footnotes?
            \peek_meaning:NTF \footnote
              {
                \bool_set_true:N \l_fnpct_multiple_footnotes_bool
                % else insert space and then footnote
                \skip_horizontal:N \l_fnpct_before_footnote_dim
                \IfNoValueTF { #2 }
                  { #1 { #3 } }
                  { #1 [ #2 ] { #3 } }
                \textsuperscript { , }
              }
              {
                % else insert space and then footnote
                \bool_if:NTF \l_fnpct_multiple_footnotes_bool
                  { \bool_set_false:N \l_fnpct_multiple_footnotes_bool }
                  { \skip_horizontal:N \l_fnpct_before_footnote_dim }
                \IfNoValueTF { #2 }
                  { #1 { #3 } }
                  { #1 [ #2 ] { #3 } }
              }
            
          }
      }
  }
\tex_endinput:D
% --------------------------------------------------------------------------
HISTORY
2012/05/18 v0.1

% --------------------------------------------------------------------------
% TODO:
- not working: multiple footnotes followed by a . or a ,
  or rather: only working when `punct-after=true'
- what about \footcite{}, \footfullcite{} and the kind?